name: Conventional Commit Check

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  conventional-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure all commits follow Conventional Commits format
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail
          echo "Checking commit subjects between $BASE_SHA and $HEAD_SHA"
          subjects=$(git log --format=%s "$BASE_SHA..$HEAD_SHA")
          if [ -z "$subjects" ]; then
            echo "No commits found in range."
            exit 1
          fi

          failed=0
          while IFS= read -r subject; do
            if echo "$subject" | grep -Eq '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([^)]+\))?(!)?: .+'; then
              echo "✔ $subject"
            else
              echo "✘ Not a Conventional Commit: $subject"
              failed=1
            fi
          done <<< "$subjects"

          if [ "$failed" -eq 1 ]; then
            echo ""
            echo "All commits must follow Conventional Commits format so that rebase-and-merge"
            echo "lands only releasable commits on main."
            echo "Each commit must look like: feat: ..., fix(scope): ..., chore: ..."
            echo "Please refer to https://www.conventionalcommits.org/en/v1.0.0/#summary for more details."
            exit 1
          fi
          echo "All commits follow Conventional Commits format."
